#!/usr/bin/env bash

goDotfiles() {
    pushd $DOTFILES > /dev/null
}

dotfilesCommit() {
    pushd $DOTFILES > /dev/null
    case $1 in
        all)
            dotfilesCommit && \
            dotfilesCommit secret
            ;;
        secret)
            echo -e "${COLOR_RED}Commiting secret dotfiles.${COLOR_NC}"
            git secret hide && \
            git add . && \
            git commit -m "auto commit secrets" && \
            git push && \
            git secret reveal -f -p $GIT_SECRET_PASS
            ;;
        *)
            echo -e "${COLOR_RED}Commiting dotfiles.${COLOR_NC}"
            git add . && \
            git commit -m "auto commit" && \
            git push
            ;;
    esac
    popd > /dev/null
}

dotfilesPull () {

    pushd $DOTFILES > /dev/null
    git fetch
    git pull
    git secret reveal -p $GIT_SECRET_PASS
    popd > /dev/null

}

dotfilesSource() {
    if [[ -z "$DOTFILES" ]]; then
        export DOTFILES="${1:-$HOME/.dotfiles}"
    fi
    source $DOTFILES/shell/common
}

dotfilesLink() {
    echo Linking dotfiles...
    pushd $DOTFILES > /dev/null && ./install -Q ; popd > /dev/null
    # clear
}


dotfilesInstall() {
    if [[ -z "$@" ]]
    then
        echo Here is the list of available scripts:
        find $DOTFILES/software/ \
            | fzf --select-1 --height 50% --multi --bind "space:toggle" \
            | xargs -L1 -I FILES bash -c "FILES"
    else
        echo "$@"
        for pkg in "$@"
        do
            echo Installing $pkg
            source $DOTFILES/software/$pkg
        done
    fi
}



dotfiles() {
    case $1 in
        install)
            dotfilesInstall ${@:2} ;;
        i)
            dotfilesInstall ${@:2} ;;
        cd)
            goDotfiles ;;
        go)
            goDotfiles ;;
        cm)
            dotfilesCommit ;;
        commit)
            dotfilesCommit ;;
        ca)
            dotfilesCommit all ;;
        cs)
            dotfilesCommit secret ;;
        source)
            dotfilesSource ;;
        pull)
            dotfilesPull ;;
        link)
            dotfilesLink ;;
        e)
            dotfiles edit ;;
        edit)
            pushd $DOTFILES > /dev/null
            nvim .
            popd > /dev/null
            ;;
        ec)
            dotfiles edit
            dotfiles commit
            ;;

        new)
            newExecutable $2 $3
            ;;
        *)
            echo
            echo "Usage: "
            echo
            echo "$ dotfiles <cmd> <args>"
            echo
            echo "Commands: "
            echo
            echo "                     go, cd : go to dotfiles' folder"
            echo "                 commit, cm : commit files automatically"
            echo "                         cs : commit secrets only"
            echo "                         ca : commit all (files and secrets) files automatically"
            echo "                     source : reload dotfiles"
            echo "                       pull : pull dotfiles changes"
            echo "                       link : (re)create symlinks of dotfiles"
            echo "                    edit, e : edit dotfiles"
            echo "                         ec : edit and commit dotfiles"
            echo " install, i <name or names> : install using software's folder"
            echo "          new <path> <name> : new executable in <path>/<name>"
            ;;
    esac
}

dotfiles ${@}
