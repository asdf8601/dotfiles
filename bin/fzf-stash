#!/usr/bin/env bash

if command -v bat >/dev/null 2>&1; then
    show_preview='echo {} | awk -F":" "{print \$1}" | xargs -I {} sh -c "git stash show -p {} > /tmp/stash-preview && bat --color=always /tmp/stash-preview"'
    ls_preview='echo {} | awk -F":" "{print \$1}" | xargs -I {} sh -c "git stash show --name-only {} > /tmp/stash-preview && bat --color=always /tmp/stash-preview"'
else
    show_preview='echo {} | awk -F":" "{print \$1}" | xargs -I {} git stash show -p {}'
    ls_preview='echo {} | awk -F":" "{print \$1}" | xargs -I {} git stash show --name-only {}'
fi

case $1 in
    show)
        preview=${show_preview}
        ;;
    ls)
        preview=${ls_preview}
        ;;
    h|help)
        echo "Usage: $0 {show|ls}"
        exit 1
        ;;
    *)
        preview=${show_preview}
esac

stashes=$(git stash list | fzf --multi --preview "$preview" --preview-window=right:70%:wrap)

if [ -n "$stashes" ]; then
    echo "$stashes" | awk -F: '{print $1}' | while read stash; do
        git stash apply "$stash"
    done
fi
