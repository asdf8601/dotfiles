#!/usr/bin/env bash

if command -v bat >/dev/null 2>&1; then
    show_preview='echo {} | awk -F":" "{print \$1}" | xargs -I {} sh -c "git stash show -p {} > /tmp/stash-preview && bat --color=always /tmp/stash-preview"'
    ls_preview='echo {} | awk -F":" "{print \$1}" | xargs -I {} sh -c "git stash show --name-only {} > /tmp/stash-preview && bat --color=always /tmp/stash-preview"'
    diff_preview='echo {} | awk -F":" "{print \$1}" | xargs -I {} sh -c "git stash show -p {} > /tmp/stash-preview && git diff {} $2 > /tmp/stash-diff && bat --color=always /tmp/stash-diff"'

else
    show_preview='echo {} | awk -F":" "{print \$1}" | xargs -I {} git stash show -p {}'
    ls_preview='echo {} | awk -F":" "{print \$1}" | xargs -I {} git stash show --name-only {}'
    diff_preview='echo {} | awk -F":" "{print \$1}" | xargs -I {} sh -c "git stash show -p {} > /tmp/stash-preview && git diff {} $2 > /tmp/stash-diff && cat /tmp/stash-diff"'

fi

case $1 in
    show)
        preview=${show_preview}
        ;;
    ls)
        preview=${ls_preview}
        ;;
    diff)
        if [ -z "$2" ]; then
            echo "Usage: $0 diff <branch>"
            exit 1
        fi
        preview=${diff_preview}
        ;;
    h|help)
        echo "Usage: $0 {show|ls}"
        exit 1
        ;;
    *)
        preview=${show_preview}
esac

stashes=$(git stash list | fzf --multi --preview "$preview" --preview-window=right:70%:wrap)

if [ -n "$stashes" ]; then
    echo "$stashes" | awk -F: '{print $1}' | while read stash; do
        git stash apply "$stash"
    done
fi
