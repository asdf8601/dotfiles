#!/usr/bin/env -S uv run --script
# /// script
# dependencies = [
#   "pyobjc",
# ]
# ///

import sys
import argparse
import subprocess
import time
from Foundation import NSAppleScript
from AppKit import NSScreen

def get_pid_from_aerospace(title_substring):
    """Uses AeroSpace CLI to find the PID of a window matching the title."""
    try:
        # aerospace list-windows --all --format "%{app-pid} | %{window-title}"
        cmd = ["aerospace", "list-windows", "--all", "--format", "%{app-pid} | %{window-title}"]
        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        for line in result.stdout.splitlines():
            if title_substring in line:
                return line.split("|")[0].strip()
    except Exception as e:
        print(f"AeroSpace lookup failed: {e}")
    return None

def center_window(target_pid=None, target_title=None):
    screen = NSScreen.mainScreen()
    v_frame = screen.visibleFrame()
    f_frame = screen.frame()
    s_width = v_frame.size.width
    s_height = v_frame.size.height
    s_x = v_frame.origin.x
    s_y = f_frame.size.height - v_frame.origin.y - v_frame.size.height

    # If title provided, try to resolve to PID via AeroSpace first (more reliable)
    if target_title and not target_pid:
        print(f"Resolving title '{target_title}' via AeroSpace...")
        # Retry a few times as window might be spawning
        for _ in range(10):
            target_pid = get_pid_from_aerospace(target_title)
            if target_pid:
                break
            time.sleep(0.1)

    if target_pid:
        target_logic = f'first process whose unix id is {target_pid}'
        print(f"Targeting process with PID: {target_pid}")
    elif target_title:
        target_logic = f'first process whose background only is false and (title of every window contains "{target_title}")'
        print(f"Targeting window with title (fallback): {target_title}")
    else:
        target_logic = 'first process whose frontmost is true'
        print("Targeting frontmost window")

    script_source = f"""
    tell application "System Events"
        try
            set theProcess to {target_logic}
            tell theProcess
                set theWindow to window 1
                set {{wWidth, wHeight}} to size of theWindow
                
                -- Resize if it's currently full screen/maximized
                if wWidth >= {s_width} - 10 then
                    set wWidth to 1200
                    set wHeight to 800
                    set size of theWindow to {{wWidth, wHeight}}
                end if
                
                set newX to {s_x} + ({s_width} - wWidth) / 2
                set newY to {s_y} + ({s_height} - wHeight) / 2
                
                set position of theWindow to {{newX, newY}}
                set frontmost to true
                return "Centered window of " & (name of theProcess) & " (PID: " & (unix id of theProcess) & ")"
            end tell
        on error err
            return "Error: " & err
        end try
    end tell
    """
    
    as_obj = NSAppleScript.alloc().initWithSource_(script_source)
    output, error = as_obj.executeAndReturnError_(None)
    
    if error:
        print(f"AppleScript execution failed: {error}")
    else:
        print(f"Result: {output.stringValue()}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("title_or_pid", nargs="?", help="Target window title substring or PID")
    parser.add_argument("--pid", type=int, help="Target process PID")
    parser.add_argument("--title", help="Target window title substring")
    args = parser.parse_args()
    
    # Handle positional argument
    pid = args.pid
    title = args.title
    
    if args.title_or_pid:
        if args.title_or_pid.isdigit():
            pid = int(args.title_or_pid)
        else:
            title = args.title_or_pid
            
    center_window(target_pid=pid, target_title=title)
