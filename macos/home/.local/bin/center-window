#!/usr/bin/env -S uv run --script
# /// script
# dependencies = [
#   "pyobjc",
# ]
# ///

import sys
import argparse
import subprocess
import time
from Foundation import NSAppleScript
from AppKit import NSScreen

def get_pid_from_ps(title_substring):
    try:
        # Buscamos el proceso ghostty que contenga el título en sus argumentos
        cmd = f"ps -ww -eo pid,command | grep '[g]hostty.*{title_substring}' | awk '{{print $1}}'"
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        pids = result.stdout.strip().split()
        if pids:
            return int(pids[0])
    except:
        pass
    return None

def center_window(target_pid=None, target_title=None):
    screen = NSScreen.mainScreen()
    v_frame = screen.visibleFrame()
    f_frame = screen.frame()
    s_width = v_frame.size.width
    s_height = v_frame.size.height
    s_x = v_frame.origin.x
    s_y = f_frame.size.height - v_frame.origin.y - v_frame.size.height

    if target_title and not target_pid:
        # Bucle más rápido: 20 reintentos cada 0.05s (1s total max)
        for _ in range(20):
            target_pid = get_pid_from_ps(target_title)
            if target_pid:
                break
            time.sleep(0.05)

    # AppleScript optimizado: acceso directo por PID
    if target_pid:
        target_process = f'application process whose unix id is {target_pid}'
    else:
        target_process = 'first application process whose frontmost is true'

    script_source = f"""
    tell application "System Events"
        try
            set theProcess to {target_process}
            set theWindow to window 1 of theProcess
            set {{wWidth, wHeight}} to size of theWindow
            
            if wWidth >= {s_width} - 20 then
                set wWidth to 1200
                set wHeight to 800
                set size of theWindow to {{wWidth, wHeight}}
            end if
            
            set newX to {s_x} + ({s_width} - wWidth) / 2
            set newY to {s_y} + ({s_height} - wHeight) / 2
            
            set position of theWindow to {{newX, newY}}
            set frontmost of theProcess to true
            return "Centered PID " & {target_pid or "front"}
        on error err
            return "Error: " & err
        end try
    end tell
    """
    
    as_obj = NSAppleScript.alloc().initWithSource_(script_source)
    as_obj.executeAndReturnError_(None)

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("title_or_pid", nargs="?", help="Title or PID")
    args = parser.parse_args()
    
    pid = int(args.title_or_pid) if args.title_or_pid and args.title_or_pid.isdigit() else None
    title = args.title_or_pid if args.title_or_pid and not args.title_or_pid.isdigit() else None
            
    center_window(target_pid=pid, target_title=title)
